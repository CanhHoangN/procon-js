<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Render Map</title>
    <link rel="stylesheet" href="../cssProcon/css.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <link rel="stylesheet" href="../css/bootstrap.css">
    <script src="../js/bootstrap.js"></script>

    <style>
        .map{


        }
        img{
            width: 1000px;
            height: 200px;
        }

    </style>
</head>

<body>
    <div class="container">
        <div class="img">
            <img src="../img/hd.png"/>
        </div>
        <div class="map">
            <ul>
            </ul>
        </div>
        <div class="demo">
            <br>
            <button id="action">action</button>
        </div>
    </div>
<script>
    // get token roi dan vao day
    var token = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJkYXRhIjoidGVhbTFfdGVzdCIsImlhdCI6MTU3MDQ2MDAwNSwiZXhwIjoxNTcwNDY3MjA1fQ.U7f43cUrnpreCyaq-DNSuXFQYpa_gsyEe8ovq-B6Szc";
    var prevGame = [
        {
            "id": 0,
            "intervalMillis": 0,
            "matchTo": "string",
            "teamID": 0,
            "turnMillis": 0,
            "turns": 0
        }
    ];
    var statusNow = {
        "actions": [
            {
                "agentID": 0,
                "dx": 0,
                "dy": 0,
                "type": "move",
                "apply": -1,
                "turn": 0
            }
        ],
        "height": 0,
        "points": [
            [
                0
            ]
        ],
        "startedAtUnixTime": 0,
        "teams": [
            {
                "agents": [
                    {
                        "agentID": 0,
                        "x": 0,
                        "y": 0
                    }
                ],
                "areaPoint": 0,
                "teamID": 0,
                "tilePoint": 0
            }
        ],
        "tiled": [
            [
                0
            ]
        ],
        "turn": 0,
        "width": 0
    };
    var postStatusAgent ={
        "actions": [
            {
                "agentID": 0,
                "dx": 0,
                "dy": 0,
                "type": "move"
            }
        ]
    };



    $(document).ready(function () {
        var load = true;
        var json = {};
        var pointAgents = {};
        function getJson(data){
            json = data;
        }
        var arrId = function(){
            var arr =[];
            $.ajax({
                async: false,
                url: 'http://sv-procon.uet.vnu.edu.vn:3000/matches',
                type:'GET',
                dateType:'json',
                headers: {"Authorization":token},
                success:function (data) {
                    console.log(data);
                    arr = data;
                },

                error:function (error) {
                    console.log(error);
                }

            });
            return arr;

        }();

        var id = arrId[0].id;
        console.log("id "+id);
        if(load === true){
            function getState(){
                var res = null;
                $.ajax({
                    async: false,
                    url: 'http://sv-procon.uet.vnu.edu.vn:3000/matches/'.concat(id+"'"),
                    type:'GET',
                    dateType:'json',
                    headers: {"Authorization":token},
                    success:function (data) {
                        console.log(data);
                        res = data;
                    },
                    error:function (error) {
                        console.log(error);
                    }

                });
                return res;
            }
            load = false;
            json = getState();
        }

        // console.log("asdas"+json.points);
        var json1= {
            "actions": [
                {
                    "agentID": 9,
                    "type": "move",
                    "dx": 1,
                    "dy": 0,
                }
            ]
        };

        function postAction(){
            $.ajax({
                url: 'http://sv-procon.uet.vnu.edu.vn:3000/matches/'.concat(id+'/action'),
                type:'POST',
                dateType:'json',
                contentType: 'application/json',
                data:JSON.stringify(json1),
                headers: {"Authorization":token},
                success:function (data) {
                    console.log("data: "+data);
                },
                error:function (error) {
                    console.log(error);
                }
            }).done(function () {
                setTimeout(function(){ location.reload(); }, 8000);
            });


        }
        $('#action').click(function () {
            postAction();

        });
        var actionTeamOne = {};
        var actionTeamTwo = {};

        var cl = '';
        var color = '';
        var bol = false;
        var agentsTeamOne = json.teams[0].agents;
        var agentsTeamTwo = json.teams[1].agents;
        var idTeamOne = json.teams[0].teamID;
        var idTeamTwo = json.teams[1].teamID;
        // idTeamTwo =json.teams[1];
        //console.log(agentsTeamOne);
        var tiled = json.tiled;
        // console.log(tiled);
        var value ;
        var pointsAgent ;
        //console.log(agentsTeamOne[0].x;
        var vtAgentTeamOne = json.teams[0].agents;
        console.log(vtAgentTeamOne);
        var vtAgentTeamTwo = json.teams[1].agents;
        function checkPoint(i,j) {

            for(var z = 0 ; z < 5 ; z++){

                if(((vtAgentTeamOne[z].x-1) === i )&& ((vtAgentTeamOne[z].y-1) === j)){
                    return {
                        agent : vtAgentTeamOne[z].agentID,
                        tf : true
                    };
                }
            }
            return {
                agent : null,
                tf : false
            }
        }
        function checkPoint_two(i,j) {

            for(var z = 0 ; z < 5 ; z++){

                if(((vtAgentTeamTwo[z].x-1) === i )&& ((vtAgentTeamTwo[z].y-1) === j)){
                    return {
                        agent : vtAgentTeamTwo[z].agentID,
                        tf : true
                    };
                }
            }
            return {
                agent : null,
                tf : false
            }
        }

        var pointElTeamOne = 1;
        var pointElTeamTwo = 1;
       /* for(var i = 0 ; i < agentsTeamOne.length; i++){
            prevAgentsTeamOne.push([agentsTeamTwo[i].x,agentsTeamTwo[i].y]);
            prevAgentsTeamTwo.push([agentsTeamOne[i].x,agentsTeamOne[i].y]);
        }*/

        $(".map").css({
            width:json.width*40+json.width*2+40,
            height: json.height*35+json.height*2
        });
        function reload() {
            for(var i = 0 ; i < json.height ; i++){
                for(var j = 0 ; j < json.width ; j++){
                    if(tiled[i][j] === idTeamOne){
                        cl = "el elTeamOne";

                        var point = checkPoint(j,i);
                        if(point.tf === true){
                            $("ul").append("<li"+ " class="+"'"+cl+"'" +" style='width: 40px;float:left'"+" value="+"'"+pointElTeamOne.toString()+"'>".concat("("+point.agent+")"+json.points[i][j]+"</li>"));
                        }else
                        {
                            $("ul").append("<li"+ " class="+"'"+cl+"'" +" style='width: 40px;float:left'"+" value="+"'"+pointElTeamOne.toString()+"'>".concat(json.points[i][j]+"</li>"));
                        }

                        pointElTeamOne++;
                    }else if(tiled[i][j] === idTeamTwo){
                        cl = "el elTeamTwo";
                        var point_two = checkPoint_two(j,i);
                        if(point_two.tf === true){
                            $("ul").append("<li"+ " class="+"'"+cl+"'" +" style='width: 40px;float:left'"+" value="+"'"+i.toString()+j.toString()+"'>".concat("("+point_two.agent+")"+json.points[i][j]+"</li>"));
                        }else
                        {
                            $("ul").append("<li"+ " class="+"'"+cl+"'" +" style='width: 40px;float:left'"+" value="+"'"+i.toString()+j.toString()+"'>".concat(json.points[i][j]+"</li>"));
                        }

                        pointElTeamTwo++;
                    }else{
                        cl = "el";
                        $("ul").append("<li"+ " class="+"'"+cl+"'" +" style='width: 40px;float:left'"+" value="+"'"+i.toString()+j.toString()+"'>".concat(json.points[i][j]+"</li>"));
                    }


                }

            }
        }
        reload();

       /* $("li").click(function () {
            $('li[value='+value+']').removeClass('stayHere');

            var point = $(this).attr('value');
            if(bol === true){
                $(this).addClass("elTeamOne stayHere");
                $(this).attr({
                    value:pointsAgent
                })
            }
            bol = false;
            value = $(this).attr('value');
        });

        $('li').click(function () {
            //alert($(this).attr('value'));
            $('#agentid').attr({
                value:$(this).attr('value')
            })
        });
        $('#action').click(function(){
            var obj =
                {
                    "actions": [
                        {
                            "agentID": $('#agentid').val(),
                            "dx": $('#dx').val(),
                            "dy": $('#dy').val(),
                            "type": $('select').val()
                        }
                    ]
                };
            console.log(JSON.stringify(obj));
        });*/


    });
</script>
</body>
</html>